// Модуль активов и пассивов
(function(){
  // Открытие формы покупки недвижимости/бизнеса/золота
  window.openOtherAssetForm = function(type) {
    const wrap = document.getElementById('main-other-asset-form-wrap');
    wrap.classList.add('active');
    wrap.setAttribute('data-asset-type', type);
    const form = document.getElementById('main-other-asset-form');
    // Для недвижимости
    if (type === 'Недвижимость') {
      form.innerHTML = `
        <label>Имя объекта:
          <input type="text" id="realty-object-name" style="width:100%;margin-top:6px;padding:8px 6px;font-size:1em;">
        </label>
        <label>Полная стоимость объекта:
          <input type="number" id="realty-full-price" min="0" value="" style="width:100%;padding:8px 6px;font-size:1em;">
        </label>
        <label>Первоначальный взнос:
          <input type="number" id="realty-down-payment" min="0" value="" style="width:100%;padding:8px 6px;font-size:1em;">
        </label>
        <label>Денежный поток:
          <input type="number" id="realty-passive-income" min="-999999" value="0" required style="width:100%;padding:8px 6px;font-size:1em;">
        </label>
        <button type="submit" style="background:#1976d2;color:#fff;padding:10px 0;font-size:1.1em;border:none;border-radius:6px;cursor:pointer;">Купить</button>
        <button type="button" id="main-other-asset-cancel" style="margin-top:6px;background:#eee;color:#1976d2;padding:8px 0;font-size:1em;border:none;border-radius:6px;cursor:pointer;">Отмена</button>
      `;
      setTimeout(() => {
        document.getElementById('main-other-asset-cancel').onclick = function() {
          wrap.classList.remove('active');
        };
      }, 0);
      // Новый обработчик submit для недвижимости
      form.onsubmit = function(e) {
        e.preventDefault();
        const obj = document.getElementById('realty-object-name').value.trim();
        const fullPrice = Number(document.getElementById('realty-full-price').value);
        const downPayment = Number(document.getElementById('realty-down-payment').value);
        const passive = Number(document.getElementById('realty-passive-income').value);
        let valid = true;
        if (!obj) valid = false;
        if (isNaN(fullPrice) || fullPrice <= 0) valid = false;
        if (isNaN(downPayment) || downPayment < 0) valid = false;
        if (isNaN(passive)) valid = false;
        if (!valid) {
          alert('Заполните все поля корректно!');
          return;
        }
        if (window.cash < downPayment) {
          alert('Недостаточно средств!');
          return;
        }
        // Явная инициализация window.data и income
        if (typeof window.data !== 'object' || !window.data) window.data = {};
        if (!Array.isArray(window.data.asset)) window.data.asset = [];
        if (!Array.isArray(window.data.income)) window.data.income = [];
        window.cash = Number(window.cash) - Number(downPayment);
        window.data.asset.push({ name: obj, value: fullPrice });
        window.data.income.push({ name: 'Пассивный доход: ' + obj, value: passive });
        if (typeof window.saveData === 'function') window.saveData();
        if (typeof window.renderAll === 'function') window.renderAll();
        if (typeof window.renderCash === 'function') window.renderCash();
        if (typeof window.renderSummary === 'function') window.renderSummary();
        if (typeof window.renderIncome === 'function') window.renderIncome();
        if (typeof window.addHistory === 'function') window.addHistory('Покупка', 'Недвижимость', obj, downPayment, `Пассивный доход: ${passive}, Полная стоимость: ${fullPrice}`);
        wrap.classList.remove('active');
      };
    } else if (type === 'Бизнес') {
      form.innerHTML = `
        <label>Имя бизнеса:
          <input type="text" id="biz-object-name" style="width:100%;margin-top:6px;padding:8px 6px;font-size:1em;">
        </label>
        <label>Полная стоимость бизнеса:
          <input type="number" id="biz-full-price" min="0" value="" style="width:100%;padding:8px 6px;font-size:1em;">
        </label>
        <label>Первый взнос:
          <input type="number" id="biz-down-payment" min="0" value="" style="width:100%;margin-top:6px;padding:8px 6px;font-size:1em;">
        </label>
        <label>Пассивный доход:
          <input type="number" id="biz-passive" min="0" value="0" style="width:100%;margin-top:6px;padding:8px 6px;font-size:1em;">
        </label>
        <button type="submit" style="background:#1976d2;color:#fff;padding:10px 0;font-size:1.1em;border:none;border-radius:6px;cursor:pointer;">Купить</button>
        <button type="button" id="main-other-asset-cancel" style="margin-top:6px;background:#eee;color:#1976d2;padding:8px 0;font-size:1em;border:none;border-radius:6px;cursor:pointer;">Отмена</button>
      `;
      document.getElementById('main-other-asset-cancel').onclick = function() {
        wrap.classList.remove('active');
      };
      form.onsubmit = function(e) {
        e.preventDefault();
        const obj = document.getElementById('biz-object-name').value.trim();
        const fullPrice = Number(document.getElementById('biz-full-price').value);
        const downPayment = Number(document.getElementById('biz-down-payment').value);
        const passive = Number(document.getElementById('biz-passive').value);
        let valid = true;
        if (!obj) valid = false;
        if (isNaN(fullPrice) || fullPrice <= 0) valid = false;
        if (isNaN(downPayment) || downPayment < 0) valid = false;
        if (isNaN(passive)) valid = false;
        if (!valid) {
          alert('Заполните все поля корректно!');
          return;
        }
        if (window.cash < downPayment) {
          alert('Недостаточно средств!');
          return;
        }
        // Явная инициализация window.data и income
        if (typeof window.data !== 'object' || !window.data) window.data = {};
        if (!Array.isArray(window.data.asset)) window.data.asset = [];
        if (!Array.isArray(window.data.income)) window.data.income = [];
        window.cash = Number(window.cash) - Number(downPayment);
        window.data.asset.push({ name: obj, value: fullPrice });
        window.data.income.push({ name: 'Пассивный доход: ' + obj, value: passive });
        if (typeof window.saveData === 'function') window.saveData();
        if (typeof window.renderAll === 'function') window.renderAll();
        if (typeof window.renderCash === 'function') window.renderCash();
        if (typeof window.renderSummary === 'function') window.renderSummary();
        if (typeof window.renderIncome === 'function') window.renderIncome();
        if (typeof window.addHistory === 'function') window.addHistory('Покупка', 'Бизнес', obj, downPayment, `Пассивный доход: ${passive}, Полная стоимость: ${fullPrice}`);
        wrap.classList.remove('active');
      };
    }
  };

  // Открытие модального окна продажи актива
  window.openSellModal = function(type) {
    // Проверка и инициализация window.data и window.data.asset
    if (typeof window.data !== 'object' || !window.data) {
      window.data = {};
    }
    if (!Array.isArray(window.data.asset)) {
      window.data.asset = [];
    }
    // Добавил проверку для window.data.income, так как она тоже используется
    if (!Array.isArray(window.data.income)) {
        window.data.income = [];
    }

    const modal = document.getElementById('sell-modal');
    const select = document.getElementById('sell-asset-select');
    const qtyBlock = document.getElementById('sell-qty-block');
    select.innerHTML = '';
    // Фильтруем активы по типу
    let assets = [];
    if (type === 'Акции') {
      assets = window.data.asset.filter(a => /\((\d+) шт\./.test(a.name));
    } else if (type === 'Недвижимость') {
      const realtyNames = ['2/1','3/2','2п','4п','8п','16а','Многоквартирный','Земля'];
      assets = window.data.asset.filter(a => realtyNames.some(rn => a.name === rn || a.name.startsWith(rn + ',') || a.name.startsWith(rn + ' ')));
    } else if (type === 'Бизнес') {
      assets = window.data.asset.filter(a => window.data.income && window.data.income.some(i => i.name === 'Пассивный доход: ' + a.name));
    }
    assets.forEach((a, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = a.name + ' (на сумму ' + a.value + ')';
      select.appendChild(opt);
    });
    if (assets.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Нет активов для продажи';
      select.appendChild(opt);
    }
    // Показываем/скрываем блок количества для акций
    select.onchange = function() {
      const idx = select.selectedIndex;
      if (type === 'Акции' && assets[idx]) {
        qtyBlock.style.display = '';
        const match = assets[idx].name.match(/\((\d+) шт\./);
        if (match) {
          document.getElementById('sell-qty').max = match[1];
          document.getElementById('sell-qty').value = match[1];
        } else {
          document.getElementById('sell-qty').value = 1;
        }
      } else {
        qtyBlock.style.display = 'none';
      }
    };
    select.onchange();
    // Явно показываю qtyBlock для акций после открытия модалки
    if (type === 'Акции') {
      let qtyBlock = document.getElementById('sell-qty-block');
      if (!qtyBlock) {
        // Если блока нет, добавляем его динамически
        const form = document.getElementById('sell-form');
        const priceLabel = document.getElementById('sell-price').parentElement;
        qtyBlock = document.createElement('div');
        qtyBlock.id = 'sell-qty-block';
        qtyBlock.style.marginTop = '10px';
        qtyBlock.innerHTML = `<label>Количество:<input type='number' id='sell-qty' min='1' value='1'></label>`;
        form.insertBefore(qtyBlock, priceLabel);
      }
      qtyBlock.style.display = '';
    }
    modal.classList.add('active');
    // Закрытие модалки
    document.getElementById('close-sell-modal').onclick = function() {
      modal.classList.remove('active');
    };
    // Продажа
    document.getElementById('sell-form').onsubmit = function(e) {
      e.preventDefault();
      const idx = select.selectedIndex;
      if (!assets[idx]) return;
      let qty = 1;
      if (type === 'Акции') {
        qty = Number(document.getElementById('sell-qty').value) || 1;
        const match = assets[idx].name.match(/\((\d+) шт\./);
        if (!match || qty < 1 || qty > Number(match[1])) {
          alert('Некорректное количество!');
          return;
        }
      }
      const price = Number(document.getElementById('sell-price').value);
      if (!price || isNaN(price) || price <= 0) {
        alert('Введите корректную цену!');
        return;
      }
      let total = Number(price);
      if (type === 'Акции') total = Number(price) * Number(qty);
      if (total <= 0) {
        alert('Сумма продажи должна быть больше 0!');
        return;
      }
      window.cash = Number(window.cash);
      window.cash = Number(window.cash) + Number(total);
      // Уменьшаем или удаляем актив
      if (type === 'Акции') {
        const match = assets[idx].name.match(/^(.*) \((\d+) шт\..*\)$/);
        if (match) {
          const stockName = match[1];
          const oldQty = Number(match[2]);
          // --- Обновляем пассивный доход для 2BIG и CD ---
          if (stockName === '2BIG') {
            let i = window.data.income.findIndex(row => row.name === 'Пассивный доход: 2BIG');
            if (i !== -1) {
              if (qty < oldQty) {
                window.data.income[i].value = Number(window.data.income[i].value) - 10 * qty;
                if (window.data.income[i].value <= 0) window.data.income.splice(i, 1);
              } else {
                window.data.income.splice(i, 1);
              }
            }
          } else if (stockName === 'CD') {
            let i = window.data.income.findIndex(row => row.name === 'Пассивный доход: CD');
            if (i !== -1) {
              if (qty < oldQty) {
                window.data.income[i].value = Number(window.data.income[i].value) - 20 * qty;
                if (window.data.income[i].value <= 0) window.data.income.splice(i, 1);
              } else {
                window.data.income.splice(i, 1);
              }
            }
          }
          // --- Конец обновления пассивного дохода ---
          if (qty < oldQty) {
            assets[idx].name = stockName + ' (' + (oldQty - qty) + ' шт.)';
            assets[idx].value = Math.round(assets[idx].value * (oldQty - qty) / oldQty);
          } else {
            window.data.asset.splice(window.data.asset.indexOf(assets[idx]), 1);
          }
        }
      } else if (type === 'Недвижимость') {
        // Удаляем актив
        const asset = assets[idx];
        window.data.asset.splice(window.data.asset.indexOf(asset), 1);
        // Удаляем пассивный доход, если есть
        const incomeIdx = window.data.income.findIndex(row => row.name === 'Пассивный доход: ' + asset.name);
        if (incomeIdx !== -1) {
          window.data.income.splice(incomeIdx, 1);
        }
      } else if (type === 'Бизнес') {
        const asset = assets[idx];
        window.data.asset.splice(window.data.asset.indexOf(asset), 1);
        // Удаляем пассивный доход, если есть
        const incomeIdx = window.data.income.findIndex(row => row.name === 'Пассивный доход: ' + asset.name);
        if (incomeIdx !== -1) {
          window.data.income.splice(incomeIdx, 1);
        }
      }
      if (typeof window.saveData === 'function') window.saveData();
      if (typeof window.renderAll === 'function') window.renderAll();
      if (typeof window.renderCash === 'function') window.renderCash();
      if (typeof window.renderSummary === 'function') window.renderSummary();
      if (typeof window.addHistory === 'function') window.addHistory('Продажа', type, assets[idx]?.name || '', total, '');
      modal.classList.remove('active');
    };
  };

  // === ИНИЦИАЛИЗАЦИЯ ОБРАБОТЧИКОВ КНОПОК ===
  document.addEventListener('DOMContentLoaded', function() {
    // Показываем экран cashflow по умолчанию
    var screens = document.querySelectorAll('.screen');
    var cashflowScreen = document.getElementById('screen-cashflow');
    if (cashflowScreen) {
      screens.forEach(function(s) { s.classList.remove('active'); });
      cashflowScreen.classList.add('active');
    } else {
      // Явно добавляю класс active, если вдруг не сработало
      var cf = document.getElementById('screen-cashflow');
      if (cf) cf.classList.add('active');
    }

    // === ИНИЦИАЛИЗАЦИЯ КОШЕЛЬКА ===
    if (typeof window.cash !== 'number' || isNaN(window.cash)) window.cash = 0;

    // Кнопки купить/продать/действие
    var buyBtn = document.getElementById('main-buy-btn');
    var sellBtn = document.getElementById('main-sell-btn');
    var actionBtn = document.getElementById('main-action-btn');
    var buyDropdown = document.getElementById('main-buy-dropdown');
    var sellDropdown = document.getElementById('main-sell-dropdown');
    var actionDropdown = document.getElementById('main-action-dropdown');

    // Функция для закрытия всех дропдаунов
    function closeAllDropdowns() {
      buyDropdown.classList.remove('active');
      sellDropdown.classList.remove('active');
      actionDropdown.classList.remove('active');
    }

    if (buyBtn && buyDropdown) {
      buyBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isActive = buyDropdown.classList.contains('active');
        closeAllDropdowns();
        if (!isActive) {
          buyDropdown.classList.add('active');
        }
      });
    }

    if (sellBtn && sellDropdown) {
      sellBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isActive = sellDropdown.classList.contains('active');
        closeAllDropdowns();
        if (!isActive) {
          sellDropdown.classList.add('active');
        }
      });
    }

    if (actionBtn && actionDropdown) {
      actionBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isActive = actionDropdown.classList.contains('active');
        closeAllDropdowns();
        if (!isActive) {
          actionDropdown.classList.add('active');
        }
      });
    }

    // Закрытие дропдаунов при клике вне
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.action-btn') && !e.target.closest('.dropdown')) {
        closeAllDropdowns();
      }
    });

    // === ОБРАБОТЧИКИ ДЛЯ ВЫПАДАЮЩИХ МЕНЮ КУПИТЬ/ПРОДАТЬ/ДЕЙСТВИЕ ===
    // Покупка активов
    document.querySelectorAll('.main-buy-option').forEach(function(el) {
      el.onclick = function() {
        var type = el.getAttribute('data-type');
        if (type === 'Акции') {
          var stockDropdown = document.getElementById('main-stock-dropdown');
          if (stockDropdown) {
            stockDropdown.classList.add('active');
            var form = document.getElementById('main-stock-form');
            if (form) {
              if (!document.getElementById('main-stock-cancel')) {
                var cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'main-stock-cancel';
                cancelBtn.textContent = 'Отмена';
                cancelBtn.style = 'margin-left:10px;background:#eee;color:#1976d2;padding:8px 0;font-size:1em;border:none;border-radius:6px;cursor:pointer;';
                form.appendChild(cancelBtn);
                cancelBtn.onclick = function() {
                  stockDropdown.classList.remove('active');
                  form.reset();
                };
              }
              form.onsubmit = null;
              form.onsubmit = function(e) {
                e.preventDefault();
                var stock = document.getElementById('main-stock-select').value;
                var qty = Number(document.getElementById('main-stock-qty').value);
                var price = Number(document.getElementById('main-stock-price').value);
                if (!stock || qty <= 0 || isNaN(price)) {
                  alert('Заполните все поля корректно!');
                  return;
                }
                var total = qty * price;
                if (window.cash < total) {
                  alert('Недостаточно средств!');
                  return;
                }
                window.cash = Number(window.cash) - Number(total);
                if (typeof window.data !== 'object' || !window.data) window.data = {};
                if (!Array.isArray(window.data.asset)) window.data.asset = [];
                if (!Array.isArray(window.data.income)) window.data.income = [];
                var assetName = stock + ' (' + qty + ' шт.)';
                window.data.asset.push({ name: assetName, value: total });
                if (stock === '2BIG') {
                  window.data.income.push({ name: 'Пассивный доход: 2BIG', value: 10 * qty });
                } else if (stock === 'CD') {
                  window.data.income.push({ name: 'Пассивный доход: CD', value: 20 * qty });
                }
                if (typeof window.saveData === 'function') window.saveData();
                if (typeof window.renderAll === 'function') window.renderAll();
                if (typeof window.renderCash === 'function') window.renderCash();
                if (typeof window.renderSummary === 'function') window.renderSummary();
                if (typeof window.addHistory === 'function') window.addHistory('Покупка', 'Акции', assetName, total, '');
                if (typeof window.renderAll === 'function') window.renderAll();
                if (typeof window.renderCash === 'function') window.renderCash();
                if (typeof window.renderSummary === 'function') window.renderSummary();
                stockDropdown.classList.remove('active');
                form.reset();
              };
            }
          }
          // Закрываем меню только если открыли форму акций
          buyDropdown.classList.remove('active');
        } else if (type === 'Недвижимость' || type === 'Бизнес') {
          if (typeof window.openOtherAssetForm === 'function') window.openOtherAssetForm(type);
          // Закрываем меню только если открыли форму недвижимости/бизнеса
          buyDropdown.classList.remove('active');
        }
      };
    });

    // Продажа активов
    document.querySelectorAll('.main-sell-option').forEach(function(el) {
      el.onclick = function() {
        var type = el.getAttribute('data-type');
        if (typeof window.openSellModal === 'function') window.openSellModal(type);
        sellDropdown.classList.remove('active');
      };
    });

    // Действия (доход, расход, пассивный доход, кредит)
    document.querySelectorAll('.main-action-option').forEach(function(el) {
      el.onclick = function() {
        var type = el.getAttribute('data-type');
        if (type === 'Доход' || type === 'Расход') {
          var modal = document.getElementById('main-action-sum-dropdown');
          if (modal) {
            modal.classList.add('active');
            document.getElementById('action-sum-title').textContent = type;
            var form = document.getElementById('action-sum-form');
            var payoffBtn = document.getElementById('payoff-credit-btn');
            if (payoffBtn) payoffBtn.style.display = 'none';
            // Добавляем поле комментария, если его нет
            if (!document.getElementById('action-sum-comment')) {
              var commentLabel = document.createElement('label');
              commentLabel.textContent = 'Комментарий:';
              var commentInput = document.createElement('input');
              commentInput.type = 'text';
              commentInput.id = 'action-sum-comment';
              commentInput.className = 'modal-input';
              commentInput.style = 'width:100%;margin-top:6px;padding:8px 6px;font-size:1em;';
              commentLabel.appendChild(commentInput);
              form.insertBefore(commentLabel, form.querySelector('button[type="submit"]'));
            }
            // Добавляю обработчик для крестика
            var closeBtn = document.getElementById('close-action-sum-dropdown');
            if (closeBtn) {
              closeBtn.onclick = function() {
                modal.classList.remove('active');
                form.reset();
              };
            }
            if (form) {
              form.onsubmit = function(e) {
                e.preventDefault();
                var sum = Number(document.getElementById('action-sum-input').value);
                var comment = document.getElementById('action-sum-comment').value.trim();
                if (isNaN(sum) || sum <= 0) {
                  alert('Введите сумму!');
                  return;
                }
                // ИНИЦИАЛИЗАЦИЯ window.data
                if (typeof window.data !== 'object' || !window.data) window.data = {};
                if (!Array.isArray(window.data.income)) window.data.income = [];
                if (!Array.isArray(window.data.expense)) window.data.expense = [];
                if (type === 'Доход') {
                  window.cash = Number(window.cash) + Number(sum);
                  window.data.income.push({ name: 'Доход', value: sum });
                  if (typeof window.addHistory === 'function') window.addHistory('Доход', '', 'Доход', sum, comment);
                } else {
                  if (window.cash < sum) {
                    alert('Недостаточно средств!');
                    return;
                  }
                  window.cash = Number(window.cash) - Number(sum);
                  window.data.expense.push({ name: 'Расход', value: sum });
                  if (typeof window.addHistory === 'function') window.addHistory('Расход', '', 'Расход', sum, comment);
                }
                if (typeof window.saveData === 'function') window.saveData();
                if (typeof window.renderAll === 'function') window.renderAll();
                if (typeof window.renderCash === 'function') window.renderCash();
                if (typeof window.renderSummary === 'function') window.renderSummary();
                modal.classList.remove('active');
                form.reset();
              };
            }
          }
        } else if (type === 'Пассивный доход') {
          var modal = document.getElementById('main-action-sum-dropdown');
          if (modal) {
            modal.classList.add('active');
            document.getElementById('action-sum-title').textContent = 'Пассивный доход';
            var form = document.getElementById('action-sum-form');
            var payoffBtn = document.getElementById('payoff-credit-btn');
            if (payoffBtn) payoffBtn.style.display = 'none';
            // Добавляю обработчик для крестика
            var closeBtn = document.getElementById('close-action-sum-dropdown');
            if (closeBtn) {
              closeBtn.onclick = function() {
                modal.classList.remove('active');
                if (form) form.reset();
              };
            }
            if (form) {
              form.onsubmit = function(e) {
                e.preventDefault();
                var sum = Number(document.getElementById('action-sum-input').value);
                var comment = document.getElementById('action-sum-comment').value.trim();
                if (isNaN(sum) || sum <= 0) {
                  alert('Введите сумму!');
                  return;
                }
                // ИНИЦИАЛИЗАЦИЯ window.data
                if (typeof window.data !== 'object' || !window.data) window.data = {};
                if (!Array.isArray(window.data.income)) window.data.income = [];
                window.data.income.push({ name: 'Пассивный доход', value: sum });
                if (typeof window.saveData === 'function') window.saveData();
                if (typeof window.renderAll === 'function') window.renderAll();
                if (typeof window.renderSummary === 'function') window.renderSummary();
                if (typeof window.renderIncome === 'function') window.renderIncome();
                if (typeof window.addHistory === 'function') window.addHistory('Пассивный доход', '', 'Пассивный доход', sum, comment);
                modal.classList.remove('active');
                form.reset();
              };
            }
          }
        } else if (type === 'Постоянный расход') {
          var modal = document.getElementById('main-action-regular-expense-dropdown');
          if (modal) {
            modal.classList.add('active');
            var form = document.getElementById('action-regular-expense-form');
            // Удаляю добавление поля комментария
            var commentInput = document.getElementById('regular-expense-comment');
            if (commentInput) commentInput.parentElement.remove();
            form.onsubmit = function(e) {
              e.preventDefault();
              var name = document.getElementById('action-regular-expense-name').value;
              var value = Number(document.getElementById('action-regular-expense-value').value);
              if (!name || isNaN(value) || value <= 0) {
                alert('Заполните все поля!');
                return;
              }
              // ИНИЦИАЛИЗАЦИЯ window.data
              if (typeof window.data !== 'object' || !window.data) window.data = {};
              if (!Array.isArray(window.data.expense)) window.data.expense = [];
              window.data.expense.push({ name, value });
              if (typeof window.saveData === 'function') window.saveData();
              if (typeof window.renderAll === 'function') window.renderAll();
              if (typeof window.renderSummary === 'function') window.renderSummary();
              if (typeof window.renderExpense === 'function') window.renderExpense();
              if (typeof window.addHistory === 'function') window.addHistory('Постоянный расход', '', name, value, '');
              modal.classList.remove('active');
              form.reset();
            };
            // Добавляем обработчик для крестика, если нужно
            var closeBtn = document.getElementById('close-action-regular-expense-dropdown');
            if (closeBtn) {
              closeBtn.onclick = function() {
                modal.classList.remove('active');
                form.reset();
              };
            }
          }
        } else if (type === 'Кредит') {
          if (typeof window.openCreditChoiceModal === 'function') window.openCreditChoiceModal();
          return;
        }
        actionDropdown.classList.remove('active');
      };
    });

    // === PAYDAY COIN ===
    var paydayBtn = document.getElementById('payday-coin');
    if (paydayBtn) {
      paydayBtn.onclick = function() {
        // Считаем сумму зарплаты и пассивного дохода
        var salary = 0, passive = 0, expenses = 0;
        if (window.data && Array.isArray(window.data.income)) {
          window.data.income.forEach(function(a) {
            if (a.name === 'Зарплата') salary += Number(a.value) || 0;
            if (a.name && a.name.startsWith('Пассивный доход')) passive += Number(a.value) || 0;
          });
        }
        if (window.data && Array.isArray(window.data.expense)) {
          window.data.expense.forEach(function(a) {
            expenses += Number(a.value) || 0;
          });
        }
        window.cash = Number(window.cash) + salary + passive - expenses;
        if (typeof window.saveData === 'function') window.saveData();
        if (typeof window.renderAll === 'function') window.renderAll();
        if (typeof window.renderCash === 'function') window.renderCash();
        if (typeof window.renderSummary === 'function') window.renderSummary();
        if (typeof window.renderIncome === 'function') window.renderIncome();
        if (typeof window.renderExpense === 'function') window.renderExpense();
        if (typeof window.renderLiability === 'function') window.renderLiability();
      };
    }

    if (buyBtn) {
      // Удалён тестовый alert
    }
  });

  // === ОТРИСОВКА АКТИВОВ ===
  window.renderAll = function() {
    var assetList = document.getElementById('asset-list');
    var assetTotal = document.getElementById('asset-total');
    if (!assetList) return;
    if (!window.data || !Array.isArray(window.data.asset)) {
      assetList.innerHTML = '<li style="color:#888;">Нет активов</li>';
      if (assetTotal) assetTotal.textContent = '0';
      return;
    }
    if (window.data.asset.length === 0) {
      assetList.innerHTML = '<li style="color:#888;">Нет активов</li>';
      if (assetTotal) assetTotal.textContent = '0';
      return;
    }
    var total = 0;
    assetList.innerHTML = window.data.asset.map(function(a) {
      total += Number(a.value) || 0;
      return `<li>${a.name} <span style='float:right;'>${a.value}</span></li>`;
    }).join('');
    if (assetTotal) assetTotal.textContent = total;
  };

  // === ОТРИСОВКА ДОХОДОВ ===
  window.renderIncome = function() {
    var incomeList = document.getElementById('income-list');
    var incomeTotal = document.getElementById('income-total');
    if (!incomeList) return;
    if (!window.data || !Array.isArray(window.data.income)) {
      incomeList.innerHTML = '<li style="color:#888;">Нет доходов</li>';
      if (incomeTotal) incomeTotal.textContent = '0';
      return;
    }
    if (window.data.income.length === 0) {
      incomeList.innerHTML = '<li style="color:#888;">Нет доходов</li>';
      if (incomeTotal) incomeTotal.textContent = '0';
      return;
    }
    var total = 0;
    incomeList.innerHTML = window.data.income.map(function(a, i) {
      total += Number(a.value) || 0;
      return `<li>${a.name} <span style='float:right;'>${a.value}</span> <span class='remove-btn income-remove' data-index='${i}' title='Удалить'>&times;</span></li>`;
    }).join('');
    if (incomeTotal) incomeTotal.textContent = total;
    // Вешаем обработчики на крестики
    incomeList.querySelectorAll('.income-remove').forEach(function(btn) {
      btn.onclick = function() {
        var idx = Number(btn.getAttribute('data-index'));
        if (!isNaN(idx)) {
          window.data.income.splice(idx, 1);
          if (typeof window.saveData === 'function') window.saveData();
          if (typeof window.renderIncome === 'function') window.renderIncome();
          if (typeof window.renderSummary === 'function') window.renderSummary();
        }
      };
    });
  };

  // === ОТРИСОВКА РАСХОДОВ ===
  window.renderExpense = function() {
    var expenseList = document.getElementById('expense-list');
    var expenseTotal = document.getElementById('expense-total');
    if (!expenseList) return;
    if (!window.data || !Array.isArray(window.data.expense)) {
      expenseList.innerHTML = '<li style="color:#888;">Нет расходов</li>';
      if (expenseTotal) expenseTotal.textContent = '0';
      return;
    }
    if (window.data.expense.length === 0) {
      expenseList.innerHTML = '<li style="color:#888;">Нет расходов</li>';
      if (expenseTotal) expenseTotal.textContent = '0';
      return;
    }
    var total = 0;
    expenseList.innerHTML = window.data.expense.map(function(a, i) {
      total += Number(a.value) || 0;
      return `<li>${a.name} <span style='float:right;'>${a.value}</span> <span class='remove-btn expense-remove' data-index='${i}' title='Удалить'>&times;</span></li>`;
    }).join('');
    if (expenseTotal) expenseTotal.textContent = total;
    // Вешаем обработчики на крестики
    expenseList.querySelectorAll('.expense-remove').forEach(function(btn) {
      btn.onclick = function() {
        var idx = Number(btn.getAttribute('data-index'));
        if (!isNaN(idx)) {
          window.data.expense.splice(idx, 1);
          if (typeof window.saveData === 'function') window.saveData();
          if (typeof window.renderExpense === 'function') window.renderExpense();
          if (typeof window.renderSummary === 'function') window.renderSummary();
        }
      };
    });
  };

  // === ОТРИСОВКА ПАССИВОВ ===
  window.renderLiability = function() {
    var liabilityList = document.getElementById('liability-list');
    var liabilityTotal = document.getElementById('liability-total');
    if (!liabilityList) return;
    if (!window.data || !Array.isArray(window.data.liability)) {
      liabilityList.innerHTML = '<li style="color:#888;">Нет пассивов</li>';
      if (liabilityTotal) liabilityTotal.textContent = '0';
      return;
    }
    if (window.data.liability.length === 0) {
      liabilityList.innerHTML = '<li style="color:#888;">Нет пассивов</li>';
      if (liabilityTotal) liabilityTotal.textContent = '0';
      return;
    }
    var total = 0;
    liabilityList.innerHTML = window.data.liability.map(function(a) {
      total += Number(a.value) || 0;
      return `<li>${a.name} <span style='float:right;'>${a.value}</span></li>`;
    }).join('');
    if (liabilityTotal) liabilityTotal.textContent = total;
  };

  // === ОТРИСОВКА КОШЕЛЬКА ===
  window.renderCash = function() {
    var cashElem = document.getElementById('top-cash-amount');
    var cash = Number(window.cash);
    if (isNaN(cash)) cash = 0;
    if (cashElem) cashElem.textContent = cash;
  };

  // === ОТРИСОВКА ФИНАНСОВОЙ ФОРМУЛЫ ===
  window.renderSummary = function() {
    var passiveElem = document.getElementById('passive-value');
    var incomeSumElem = document.getElementById('income-sum');
    var expenseSumElem = document.getElementById('expense-sum');
    var cashflowElem = document.getElementById('cashflow');
    var salaryElem = document.getElementById('salary-value');

    var passive = 0, incomeSum = 0, expenseSum = 0, salary = 0;
    if (window.data && Array.isArray(window.data.income)) {
      window.data.income.forEach(function(a) {
        if (a.name && a.name.startsWith('Пассивный доход')) passive += Number(a.value) || 0;
        if (a.name && a.name === 'Зарплата') salary += Number(a.value) || 0;
        incomeSum += Number(a.value) || 0;
      });
    }
    if (window.data && Array.isArray(window.data.expense)) {
      window.data.expense.forEach(function(a) {
        expenseSum += Number(a.value) || 0;
      });
    }
    if (passiveElem) passiveElem.textContent = passive;
    if (incomeSumElem) incomeSumElem.textContent = incomeSum;
    if (expenseSumElem) expenseSumElem.textContent = expenseSum;
    if (salaryElem) salaryElem.textContent = salary;
    if (cashflowElem) cashflowElem.textContent = incomeSum - expenseSum;
  };

  // Функция для скрытия всех overlay и модалок
  function hideAllOverlays() {
    var overlays = [
      'sell-modal',
      'main-other-asset-form-wrap',
      'player-name-modal',
      'menu-modal',
      'main-action-sum-dropdown',
      'main-action-regular-expense-dropdown',
      'edit-history-modal',
      'calculator-modal',
      'bankrupt-modal',
      'credit-choice-modal',
      'credit-take-modal',
      'credit-payoff-modal'
    ];
    overlays.forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
  }

  // === Скрываем все overlay при клике вне модалок и кнопок ===
  window.addEventListener('click', function(e) {
    if (!e.target.closest('.modal-content') && !e.target.closest('#main-other-asset-form-wrap') && !e.target.closest('.action-btn') && !e.target.closest('.dropdown') && !e.target.closest('#calculator-btn') && !e.target.closest('#history-btn')) {
      hideAllOverlays();
    }
  });

  // === Пример данных активов (замените на реальные данные) ===
  const assets = {
    stocks: [
      { name: 'BMK', price: 100, dividend: 5, logo: 'img/bmk_logo.png' },
      { name: 'TECH', price: 250, dividend: 10, logo: 'img/tech_logo.png' }
    ],
    real_estate: [
      { name: 'Дом 3/2', price: 50000, cash_flow: 500, logo: 'img/house_logo.png' }
    ],
    business: []
  };

  // === Функция открытия модального окна покупки ===
  window.openBuyModal = function() {
    let modal = document.getElementById('buy-asset-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'buy-asset-modal';
      modal.className = 'modal'; // Добавляем класс для стилизации
      modal.innerHTML = `
        <div class="modal-content">
          <h2>Купить актив</h2>
          <div id="buy-asset-list"></div>
        </div>`;
      document.body.appendChild(modal);
    }

    // Здесь нужно заполнить #buy-asset-list содержимым (например, списком акций)
    const assetListDiv = modal.querySelector('#buy-asset-list');
    assetListDiv.innerHTML = 'Список активов для покупки...'; // Заглушка

    modal.style.display = 'flex';
  };

  // Edit history modal
  document.getElementById('close-edit-history-modal').addEventListener('click', function() {
    document.getElementById('edit-history-modal').classList.remove('active');
  });

  // Calculator modal
  document.getElementById('calculator-btn').addEventListener('click', function() {
    document.getElementById('calculator-modal').classList.add('active');
  });

  document.getElementById('close-calculator-modal').addEventListener('click', function() {
    document.getElementById('calculator-modal').classList.remove('active');
  });

  // Player name modal
  function showPlayerNameModal() {
    document.getElementById('player-name-modal').classList.add('active');
  }

  document.getElementById('player-name-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('player-name-input').value.trim();
    if (name) {
      window.data.playerName = name;
      document.getElementById('player-name-modal').classList.remove('active');
      updatePlayerName();
    }
  });

  // Bankrupt modal
  function showBankruptModal() {
    document.getElementById('bankrupt-modal').classList.add('active');
  }

  document.getElementById('close-bankrupt-modal').addEventListener('click', function() {
    document.getElementById('bankrupt-modal').classList.remove('active');
  });
})(); 